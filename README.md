# iBeacon室内定位微信小程序

基于iBeacon蓝牙设备的室内定位微信小程序。用户可以导入JSON格式的室内地图，配置iBeacon设备的位置信息，小程序将根据实时扫描到的iBeacon信号强度，结合卡尔曼滤波进行位置解算，并在地图上实时显示用户当前位置和运动轨迹。

## 功能特点

- **导入JSON地图**：支持导入特定格式的JSON地图文件，包含地图尺寸和实体信息（如墙体、区域），并在小程序中渲染。
- **配置iBeacon**：
    - **手动添加**：支持手动配置iBeacon设备的UUID、Major、Minor、坐标位置(X, Y米)、信号功率(TxPower)和可选的设备名称/MAC地址。
    - **扫描添加**：支持扫描附近的蓝牙设备，从中选择识别到的iBeacon设备，并自动填充部分信息，用户只需补充坐标即可完成配置。
    - **列表管理**：显示已配置的Beacon列表，支持编辑和删除。
- **自定义信号参数**：支持配置信号传播因子(n)，以适应不同的室内环境，提高测距精度。
- **实时定位与滤波**：
    - 基于多边测量法（需要至少3个Beacon信号）计算原始位置。
    - **RSSI滤波**：对接收到的RSSI信号进行滑动窗口平均滤波，减少瞬时跳变。
    - **初始校准**：开始定位时，进行短暂的信号采集校准，获取较稳定的初始位置估计。
    - **卡尔曼滤波**：应用卡尔曼滤波器平滑定位结果，减少位置抖动，提高轨迹连续性。
- **位置显示**：
    - 在渲染的JSON地图上实时标记用户当前位置（蓝色圆点）。
    - 显示用户运动轨迹。
    - 可选显示已配置的Beacon点位。
- **调试功能**：定位页面底部可展开调试面板，查看实时检测到的Beacon信息（距离、RSSI等）和蓝牙状态。

## 使用方法

### 1. 准备工作

- **准备JSON地图文件**：按照指定格式准备室内地图的JSON文件。文件需包含地图的宽度(`width`)和高度(`height`)（单位：米），以及一个实体列表(`entities`)。
  ```json
  {
    "width": 20.5,
    "height": 15.0,
    "entities": [
      {
        "type": "polyline",
        "points": [[0,0], [20.5,0], [20.5,15.0], [0,15.0], [0,0]],
        "closed": true,
        "color": "#333333",
        "lineWidth": 1.5
      },
      { "type": "...", "points": [...] }
    ]
  }
  ```
- **准备iBeacon设备**：准备至少3个iBeacon设备，规划并记录好它们在地图上的实际坐标位置（米）。
- **开启手机蓝牙**：确保手机蓝牙功能已开启，并已授予小程序蓝牙和位置权限。

### 2. 配置地图

1. 打开小程序，底部导航栏切换到"配置管理"标签页。
2. 默认进入"地图配置"子标签页。
3. 点击"上传地图"按钮，选择准备好的JSON格式地图文件。
4. 上传成功后，地图预览区域会显示渲染的地图。
5. 点击"保存配置"按钮，将地图信息保存到小程序缓存。

### 3. 配置iBeacon设备

1. 在"配置管理"页面，切换到"Beacon配置"子标签页。
2. **方式一：扫描添加**
   - 点击"扫描Beacon"按钮，小程序将开始扫描周围的蓝牙设备。
   - 扫描结果会以列表形式显示（已配置过的Beacon不会出现在扫描结果中）。
   - 点击希望添加的Beacon条目。
   - 弹窗中会自动填充UUID、Major、Minor、设备ID（MAC地址，若有）、设备名称（若有）和参考TxPower。
   - **手动输入该Beacon在地图上的X坐标和Y坐标（米）**。
   - （可选）修改设备名称。
   - 点击"确认"完成添加。
3. **方式二：手动添加**
   - 点击"添加Beacon"按钮。
   - 在弹窗中手动输入以下必填信息：
     - UUID：iBeacon设备的UUID（标准格式）。
     - 位置X(米)：设备在地图上的X坐标(米)。
     - 位置Y(米)：设备在地图上的Y坐标(米)。
     - 信号功率(dBm @ 1m)：设备在1米处的参考信号强度(TxPower，通常是负值，如-59)。
   - 输入以下可选信息：
     - Major：iBeacon设备的Major值（数字）。
     - Minor：iBeacon设备的Minor值（数字）。
     - 设备名称：为Beacon设置一个方便识别的名称。
     - MAC地址(设备ID)：如果知道设备的MAC地址，可以填入。
   - 点击"确认"完成添加。
4. **管理Beacon**：
   - 列表中会显示所有已配置的Beacon。
   - 点击列表中的某一项，可以进入编辑模式修改信息。
   - 点击列表项右侧的"删除"按钮，可以删除该Beacon配置。
5. **重复上述步骤，确保至少配置了3个iBeacon设备。**

### 4. 通用设置

1. 在"配置管理"页面，切换到"通用设置"子标签页。
2. 调整**信号传播因子(n)** 的滑块：
   - 该值影响RSSI到距离的转换。
   - 推荐值：开阔环境约`2`，普通室内环境约`2.5`-`3`，复杂遮挡环境约`3.5`-`4`。
   - 需要根据实际环境进行调整以获得最佳定位效果。
3. 点击"保存设置"按钮。

### 5. 开始定位

1. 底部导航栏切换到"定位地图"标签页。
2. 如果地图和Beacon已配置，会显示地图预览。
3. 点击**页面中心**的"开始定位"按钮。
4. **初始校准**：系统会进行短暂（约3秒）的信号采集和校准，以获取稳定的初始位置。
5. 校准完成后，开始实时定位。您的位置会以**蓝色圆点**标记在地图上，并显示运动轨迹。
6. 点击"停止定位"按钮结束定位。
7. 点击页面底部的**调试信息区域标题**可以展开/收起调试面板，查看实时检测到的Beacon列表及其信号强度、估算距离等信息。
8. 点击地图右上角的"清除轨迹"按钮可以清除当前地图上显示的运动轨迹。

## 注意事项

- 定位精度受iBeacon设备部署密度、环境遮挡、信号干扰、信号传播因子设置等多种因素影响。
- 至少需要稳定接收到3个已配置的iBeacon信号才能进行有效的位置计算。
- 请确保iBeacon设备的电量充足，低电量可能导致信号不稳定或发射功率变化。
- 首次使用或系统更新后，请确保小程序已获得必要的蓝牙和位置权限。

## 技术实现

- **地图渲染**：使用微信小程序原生Canvas 2D API解析并渲染JSON格式的地图数据。
- **蓝牙扫描**：
    - 优先使用`wx.startBeaconDiscovery`和`wx.onBeaconUpdate` API进行iBeacon扫描。
    - 辅以`wx.startBluetoothDevicesDiscovery`和`wx.onBluetoothDeviceFound` API扫描普通蓝牙设备，并尝试从中解析iBeacon广播数据。
- **距离估算**：应用RSSI信号强度衰减模型 (`Distance = 10^((TxPower - RSSI) / (10 * n))`) 估算设备距离。
- **信号处理**：
    - **RSSI滤波**：对接收到的RSSI值进行滑动窗口平均滤波。
    - **初始校准**：启动时收集一段时间的信号进行平均，计算初始位置。
    - **卡尔曼滤波**：对计算出的二维坐标(x, y)应用卡尔曼滤波器进行状态估计，平滑定位结果。
- **位置解算**：主要使用多边测量法（基于估算距离）结合最小二乘法优化计算用户位置。
- **状态管理**：通过`appManager.js`模块统一管理应用状态、蓝牙状态、定位状态、地图和Beacon配置等。

## 限制与优化方向

- **RSSI波动性**：蓝牙RSSI信号本身易受多径效应、人体遮挡等影响，波动较大，是定位误差的主要来源之一。虽然已采用滤波，但无法完全消除。
- **环境依赖性**：信号传播因子(n)对环境敏感，固定值难以完美适应所有区域，导致测距误差。
- **计算模型简化**：当前定位主要依赖距离模型，未考虑设备朝向、非视距(NLOS)传播等复杂因素。
- **未来优化方向**：
    - **动态调整n值**：研究根据环境特征或历史数据动态调整信号传播因子的可能性。
    - **融合传感器数据**：结合手机内置传感器（如加速度计、陀螺仪）数据，使用更复杂的融合滤波算法（如扩展卡尔曼滤波EKF、粒子滤波PF）进一步优化轨迹。
    - **异常信号剔除**：增加更鲁棒的算法来识别和剔除异常或不可靠的Beacon信号读数。
    - **地图匹配**：将定位结果与地图结构（如墙体）进行匹配，约束定位结果在合理范围内。 